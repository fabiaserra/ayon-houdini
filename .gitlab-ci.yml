stages:
  - init
  - create
  - release

variables:
  IMAGE_TAG: 2fbed62a

get-version:
  stage: init
  image: alpine:latest
  tags:
    - mnt-pipe
  script:
    - VERSION=$(sed -n 's/version = \"\(.*\)\"/\1/p' package.py)
    - echo "VERSION=${VERSION}" > version_info.txt
  artifacts:
    reports:
      dotenv: version_info.txt
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
      when: never
    - when: manual

create-package:
  stage: create
  image: dm.tenant-alkemyx.lga1.ingress.coreweave.cloud/coreweave/pipeline/ayon/ayon-launcher/ayon-launcher:$IMAGE_TAG
  script:
    - python create_package.py
  artifacts:
    paths:
      - package
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
      when: never
    - when: manual

tag-version:
  stage: release
  dependencies:
    - get-version
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Tagging repository with ${VERSION}"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
      when: never
    - when: manual
  release:
    tag_name: '$VERSION'
    description: 'Release $VERSION using CI pipeline $CI_PIPELINE_ID'
  when: on_success
